{% extends "base.html" %}
{% block title %}{{ target_user.name }} - Face Attendance{% endblock %}
{% block content %}
<a href="{{ url_for('admin_dashboard') }}" style="color: var(--text-muted); text-decoration: none; font-size: 0.9rem; margin-bottom: 1rem; display: inline-block;">← Back to Dashboard</a>

<div style="display: grid; gap: 1.5rem; margin-top: 1rem;">
    <div style="display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap;">
        <div style="flex-shrink: 0;">
            <div style="width: 120px; height: 120px; border-radius: var(--radius); background: var(--bg-input); overflow: hidden; border: 1px solid var(--border);">
                {% if target_user.face_image_path %}
                <img src="{{ url_for('serve_face_image', user_id=target_user.id) }}" alt="Face" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">
                {% else %}
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--text-muted);">No image</div>
                {% endif %}
            </div>
        </div>
        <div>
            <h1 style="font-size: 1.5rem; margin-bottom: 0.25rem;">{{ target_user.name }}</h1>
            <p style="color: var(--text-muted);">User ID: {{ target_user.user_id }}</p>
        </div>
    </div>

    <div class="card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem;">
        <h2 style="font-size: 1.125rem; margin-bottom: 1rem;">Attendance Calendar</h2>
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <button id="prevMonth" class="btn btn-secondary" style="padding: 0.4rem 0.8rem;">←</button>
            <span id="monthLabel" style="font-weight: 600; min-width: 180px; text-align: center;"></span>
            <button id="nextMonth" class="btn btn-secondary" style="padding: 0.4rem 0.8rem;">→</button>
        </div>
        <div id="calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;"></div>
        <p style="margin-top: 1rem; color: var(--text-muted); font-size: 0.875rem;">
            <span style="display: inline-block; width: 16px; height: 16px; background: var(--success); border-radius: 4px; vertical-align: middle;"></span> Present
        </p>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const userId = {{ target_user.id }};
let year = new Date().getFullYear();
let month = new Date().getMonth() + 1;

async function loadAttendance() {
    const r = await fetch(`/api/admin/users/${userId}/attendance?year=${year}&month=${month}`);
    const data = await r.json();
    renderCalendar(data.present_days || []);
}

function renderCalendar(presentDays) {
    const first = new Date(year, month - 1, 1);
    const last = new Date(year, month, 0);
    const startPad = first.getDay();
    const daysInMonth = last.getDate();
    const presentSet = new Set(presentDays);

    document.getElementById('monthLabel').textContent = `${MONTHS[month-1]} ${year}`;

    const headers = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let html = headers.map(h => `<div style="text-align:center;font-size:0.75rem;color:var(--text-muted);padding:0.25rem;">${h}</div>`).join('');

    for (let i = 0; i < startPad; i++) html += '<div></div>';
    for (let d = 1; d <= daysInMonth; d++) {
        const isPresent = presentSet.has(d);
        html += `<div style="aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:${isPresent ? 'rgba(34,197,94,0.2)' : 'var(--bg-input)'};border-radius:8px;font-size:0.9rem;">${d}</div>`;
    }
    document.getElementById('calendar').innerHTML = html;
}

document.getElementById('prevMonth').onclick = () => { month--; if (month < 1) { month = 12; year--; } loadAttendance(); };
document.getElementById('nextMonth').onclick = () => { month++; if (month > 12) { month = 1; year++; } loadAttendance(); };

loadAttendance();
</script>
{% endblock %}
